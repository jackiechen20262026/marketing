<%- include('../partials/portal_header') %>

<div class="card" style="margin-bottom:12px">
  <h2><%= lead.company_name %></h2>
  <div class="text-muted"><%= lead.contact_name || '-' %> · <%= lead.phone || '-' %> · <%= lead.city || '-' %>/<%= lead.country || 'China' %></div>
  <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
    <span class="pill">宣传册发送: <%= lead.brochure_sent_count || 0 %></span>
    <span class="pill">拜访次数: <%= lead.visit_count || 0 %></span>
    <span class="pill">频率限制: <%= limitStatus === 'over' ? '超限' : '正常' %></span>
  </div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:start">
  <div class="card">
    <h3>基础信息（12字段）</h3>
    <table>
      <tr><th>公司</th><td><%= lead.company_name || '-' %></td></tr>
      <tr><th>联系人</th><td><%= lead.contact_name || '-' %></td></tr>
      <tr><th>街道</th><td><%= lead.street || '-' %></td></tr>
      <tr><th>门牌</th><td><%= lead.house_number || '-' %></td></tr>
      <tr><th>邮编</th><td><%= lead.postal_code || '-' %></td></tr>
      <tr><th>城市/国家</th><td><%= (lead.city || '-') + ' / ' + (lead.country || 'China') %></td></tr>
      <tr><th>社会统一号</th><td><%= lead.social_credit_code || '-' %></td></tr>
      <tr><th>公司网站</th><td><%= lead.website || '-' %></td></tr>
      <tr><th>品牌</th><td><%= lead.brand_json ? JSON.parse(lead.brand_json).join('、') : '-' %></td></tr>
      <tr><th>品类</th><td><%= lead.category || '-' %></td></tr>
      <tr><th>亚马逊shop地址</th><td><%= lead.amazon_shop_url || '-' %></td></tr>
      <tr><th>公司简介</th><td><%= lead.company_profile || '-' %></td></tr>
    </table>
  </div>

  <div class="card">
    <h3>文件/图片 + 提醒</h3>
    <form method="post" action="/portal/leads/<%= lead.id %>/upload" style="display:grid;gap:8px;margin-bottom:10px">
      <input name="file_name" placeholder="文件名" />
      <input name="file_url" placeholder="图片URL（先用URL方式上传）" required />
      <button class="btn btn-ghost" type="submit">上传图片</button>
    </form>

    <form method="post" action="/portal/leads/<%= lead.id %>/reminder" style="display:flex;gap:8px;margin-bottom:10px">
      <input name="next_visit_reminder" type="datetime-local" />
      <button class="btn" type="submit">设置提醒</button>
    </form>

    <% files.forEach(f => { %>
      <div style="margin:6px 0"><a href="<%= f.file_url %>" target="_blank"><%= f.file_name %></a></div>
    <% }) %>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <h3>活动记录</h3>
  <form method="post" action="/portal/leads/<%= lead.id %>/visit" style="display:flex;gap:8px;margin-bottom:8px">
    <input name="note" placeholder="拜访备注" style="flex:1" />
    <button class="btn" type="submit">记录拜访</button>
  </form>
  <% logs.forEach(l => { %>
    <div style="padding:8px 0;border-bottom:1px solid #eef2f7">
      <b><%= l.activity_type %></b> - <%= l.note || '-' %>
      <div class="text-muted"><%= l.operator || '-' %> · <%= new Date(l.created_at).toLocaleString() %></div>
    </div>
  <% }) %>
</div>

<%- include('../partials/portal_footer') %>
